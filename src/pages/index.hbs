<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <link rel="stylesheet" href="/style.css">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 32 32%22><rect width=%2232%22 height=%2232%22 rx=%228%22 fill=%22%233b82f6%22/><circle cx=%2216%22 cy=%2216%22 r=%228%22 fill=%22none%22 stroke=%22white%22 stroke-width=%222%22/><path d=%22M16 12v4l3 2%22 stroke=%22white%22 stroke-width=%222%22 stroke-linecap=%22round%22/></svg>">
    
    <!-- Meta Tags -->
    <meta name="description" content="å¤šäººå”ä½œçš„å¯¦æ™‚å€’è¨ˆæ™‚å·¥å…·ï¼Œæ”¯æ´åº§æ¨™è¼¸å…¥å’Œå°ç£æ™‚é–“é¡¯ç¤º">
    <meta name="keywords" content="å€’è¨ˆæ™‚,è¨ˆæ™‚å™¨,å¤šäººå”ä½œ,å¯¦æ™‚åŒæ­¥,å°ç£æ™‚é–“">
    <meta name="author" content="Countdown Timer App">
</head>
<body>
    <!-- User Name Modal -->
    <div id="user-modal" class="modal-overlay">
        <div class="modal">
            <h3>ğŸ‘‹ æ­¡è¿ä½¿ç”¨å€’è¨ˆæ™‚å·¥å…·</h3>
            <p>è«‹è¼¸å…¥ä½ çš„åå­—ï¼Œå…¶ä»–ç”¨æˆ¶å°‡æœƒçœ‹åˆ°</p>
            <input type="text" id="user-name-input" class="form-input" placeholder="è¼¸å…¥ä½ çš„åå­—" maxlength="20">
            <button id="confirm-name" class="btn-primary">ç¢ºèª</button>
            <button id="random-name" class="random-name-btn">ğŸ² éš¨æ©Ÿç”Ÿæˆåå­—</button>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>â° å¤šäººå”ä½œå€’è¨ˆæ™‚å·¥å…·</h1>
            <p>è¼¸å…¥åº§æ¨™å’Œæ™‚é–“ï¼Œå³æ™‚åŒæ­¥å€’è¨ˆæ™‚ç®¡ç†</p>
        </header>

        <!-- Main Content -->
        <div class="content">
            <!-- Input Panel -->
            <div class="input-panel">
                <!-- Current User Info -->
                <div class="user-info">
                    <div class="user-color-dot" id="current-user-color"></div>
                    <span>ç•¶å‰ç”¨æˆ¶ï¼š</span>
                    <strong id="current-user-name">è¼‰å…¥ä¸­...</strong>
                </div>

                <div class="form-section">
                    <h3>ğŸ¯ æ–°å¢å€’è¨ˆæ™‚</h3>
                    <form id="countdown-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="coord-x">X åº§æ¨™</label>
                                <input type="number" id="coord-x" class="form-input" min="0" max="9999" placeholder="0" required>
                            </div>
                            <div class="form-group">
                                <label for="coord-y">Y åº§æ¨™</label>
                                <input type="number" id="coord-y" class="form-input" min="0" max="9999" placeholder="0" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>å€’è¨ˆæ™‚é–“</label>
                            <div class="time-inputs">
                                <input type="number" id="time-minutes" class="form-input" min="0" max="59" placeholder="åˆ†é˜" required>
                                <span class="time-separator">:</span>
                                <input type="number" id="time-seconds" class="form-input" min="0" max="59" placeholder="ç§’é˜" required>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-primary">
                            â• é–‹å§‹å€’è¨ˆæ™‚
                        </button>
                    </form>
                    
                    <div id="error-message" class="error-message"></div>
                </div>

                <div class="form-section">
                    <h3>ğŸ”§ ç®¡ç†å·¥å…·</h3>
                    <button id="clear-all-btn" class="btn-danger" style="width: 100%;">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å€’è¨ˆæ™‚
                    </button>
                    <button id="sync-btn" class="random-name-btn" style="width: 100%; margin-top: 8px;">
                        ğŸ”„ æ‰‹å‹•åŒæ­¥
                    </button>
                </div>
            </div>

            <!-- Status Panel -->
            <div class="status-panel">
                <div class="status-header">
                    <h3>ğŸ“Š å€’è¨ˆæ™‚åˆ—è¡¨</h3>
                    <div class="connection-status">
                        <div class="status-indicator" id="connection-indicator"></div>
                        <span id="connection-text">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
                
                <div class="countdown-list" id="countdown-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">â³</div>
                        <p>æ­£åœ¨é€£æ¥æœå‹™å™¨...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ğŸ”§ æœ€ç°¡åŒ–çš„å‰ç«¯é€£æ¥é‚è¼¯
        console.log('ğŸ¯ é–‹å§‹åˆå§‹åŒ–...');

        // æª¢æŸ¥ Socket.IO
        if (typeof io === 'undefined') {
            console.log('ğŸ“¦ åŠ è¼‰ Socket.IO...');
            const script = document.createElement('script');
            script.src = '/socket.io/socket.io.js';
            script.onload = () => {
                console.log('âœ… Socket.IO åŠ è¼‰å®Œæˆ');
                startApp();
            };
            script.onerror = () => {
                console.error('âŒ Socket.IO åŠ è¼‰å¤±æ•—');
                showError('ç„¡æ³•åŠ è¼‰å¿…è¦çµ„ä»¶ï¼Œè«‹åˆ·æ–°é é¢');
            };
            document.head.appendChild(script);
        } else {
            console.log('âœ… Socket.IO å·²å­˜åœ¨');
            startApp();
        }

        function startApp() {
            console.log('ğŸš€ å•Ÿå‹•æ‡‰ç”¨...');
            
            // ç°¡åŒ–çš„æ‡‰ç”¨é¡
            class SimpleCountdownApp {
                constructor() {
                    this.countdowns = [];
                    this.currentUser = null;
                    this.isConnected = false;
                    
                    this.showUserModal();
                }
                
                showUserModal() {
                    const modal = document.getElementById('user-modal');
                    const nameInput = document.getElementById('user-name-input');
                    const confirmBtn = document.getElementById('confirm-name');
                    const randomBtn = document.getElementById('random-name');
                    
                    // éš¨æ©Ÿåå­—
                    randomBtn.onclick = () => {
                        const adjectives = ['å‹¤å¥®çš„', 'è°æ˜çš„', 'å¿«é€Ÿçš„', 'æº–ç¢ºçš„', 'å°ˆæ³¨çš„', 'å‰µæ–°çš„', 'ç©æ¥µçš„', 'é«˜æ•ˆçš„', 'å‹å–„çš„', 'æ¨‚è§€çš„'];
                        const nouns = ['æˆ°å£«', 'å·¥ç¨‹å¸«', 'è¨­è¨ˆå¸«', 'åˆ†æå¸«', 'å°ˆå®¶', 'ç®¡ç†è€…', 'é–‹ç™¼è€…', 'ç­–ç•¥å®¶', 'å‰µä½œè€…', 'æ¢ç´¢è€…'];
                        const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
                        const noun = nouns[Math.floor(Math.random() * nouns.length)];
                        const number = Math.floor(Math.random() * 99) + 1;
                        nameInput.value = `${adjective}${noun}${number}`;
                    };
                    
                    // ç¢ºèªæŒ‰éˆ•
                    confirmBtn.onclick = () => {
                        const name = nameInput.value.trim();
                        if (name.length >= 2) {
                            this.setUser(name);
                            modal.style.display = 'none';
                            this.initSocket();
                        } else {
                            alert('åå­—è‡³å°‘éœ€è¦2å€‹å­—ç¬¦');
                        }
                    };
                    
                    // Enter éµ
                    nameInput.onkeypress = (e) => {
                        if (e.key === 'Enter') confirmBtn.click();
                    };
                    
                    nameInput.focus();
                }
                
                setUser(name) {
                    const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1', '#14b8a6', '#fbbf24'];
                    this.currentUser = {
                        name: name,
                        color: colors[Math.floor(Math.random() * colors.length)]
                    };
                    
                    document.getElementById('current-user-name').textContent = name;
                    document.getElementById('current-user-color').style.backgroundColor = this.currentUser.color;
                    
                    console.log(`ğŸ‘¤ ç”¨æˆ¶è¨­ç½®: ${name}`);
                }
                
                initSocket() {
                    console.log('ğŸ”Œ åˆå§‹åŒ– Socket é€£æ¥...');
                    
                    // ğŸ¯ æœ€ç°¡å–®çš„ Socket.IO é…ç½®
                    this.socket = io({
                        transports: ['polling', 'websocket'], // polling å„ªå…ˆï¼Œæ›´ç©©å®š
                        upgrade: true,
                        timeout: 20000,
                        forceNew: true // å¼·åˆ¶æ–°é€£æ¥ï¼Œé¿å…ç·©å­˜å•é¡Œ
                    });
                    
                    this.setupEvents();
                }
                
                setupEvents() {
                    // é€£æ¥äº‹ä»¶
                    this.socket.on('connect', () => {
                        this.isConnected = true;
                        this.updateStatus('ğŸŸ¢ å·²é€£ç·š');
                        console.log('âœ… Socket é€£æ¥æˆåŠŸ');
                        
                        // ç™¼é€ç”¨æˆ¶ä¿¡æ¯
                        this.socket.emit('set-user-info', this.currentUser);
                    });
                    
                    this.socket.on('disconnect', () => {
                        this.isConnected = false;
                        this.updateStatus('ğŸ”´ é€£ç·šä¸­æ–·');
                        console.log('âŒ Socket é€£æ¥æ–·é–‹');
                    });
                    
                    this.socket.on('connect_error', (error) => {
                        this.isConnected = false;
                        this.updateStatus('ğŸ”´ é€£æ¥éŒ¯èª¤');
                        console.error('ğŸ”Œ é€£æ¥éŒ¯èª¤:', error);
                        this.showError('é€£æ¥æœå‹™å™¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ–åˆ·æ–°é é¢');
                    });
                    
                    // æ­¡è¿æ¶ˆæ¯
                    this.socket.on('welcome', (data) => {
                        console.log('ğŸ‰ æ”¶åˆ°æ­¡è¿æ¶ˆæ¯:', data.message);
                        this.showMessage('ğŸ‰ é€£æ¥æˆåŠŸï¼');
                    });
                    
                    // å€’è¨ˆæ™‚äº‹ä»¶
                    this.socket.on('countdown-list', (countdowns) => {
                        console.log(`ğŸ“‹ æ”¶åˆ°å€’è¨ˆæ™‚åˆ—è¡¨: ${countdowns.length} å€‹`);
                        this.countdowns = countdowns;
                        this.render();
                    });
                    
                    this.socket.on('countdown-added', (countdown) => {
                        if (!this.countdowns.find(c => c.id === countdown.id)) {
                            this.countdowns.push(countdown);
                            this.render();
                            console.log(`â• æ–°å¢: (${countdown.x},${countdown.y})`);
                        }
                    });
                    
                    this.socket.on('countdown-removed', (data) => {
                        this.countdowns = this.countdowns.filter(c => c.id !== data.id);
                        this.render();
                        console.log(`ğŸ—‘ï¸ ç§»é™¤: ID ${data.id}`);
                    });
                    
                    this.socket.on('countdowns-cleared', () => {
                        this.countdowns = [];
                        this.render();
                        console.log('ğŸ§¹ æ¸…ç©ºæ‰€æœ‰');
                    });
                    
                    this.socket.on('error', (data) => {
                        this.showError(data.message);
                        if (data.duplicateId) {
                            this.highlight(data.duplicateId);
                        }
                    });
                    
                    this.setupUI();
                }
                
                setupUI() {
                    // è¡¨å–®æäº¤
                    document.getElementById('countdown-form').onsubmit = (e) => {
                        e.preventDefault();
                        this.addCountdown();
                    };
                    
                    // æ¸…ç©ºæŒ‰éˆ•
                    document.getElementById('clear-all-btn').onclick = () => {
                        if (confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰å€’è¨ˆæ™‚ï¼Ÿ')) {
                            if (this.isConnected) {
                                this.socket.emit('clear-all');
                            } else {
                                this.showError('æœªé€£æ¥åˆ°æœå‹™å™¨');
                            }
                        }
                    };
                    
                    // åŒæ­¥æŒ‰éˆ•
                    document.getElementById('sync-btn').onclick = () => {
                        if (this.isConnected) {
                            this.socket.emit('request-sync');
                            this.showMessage('ğŸ”„ æ­£åœ¨åŒæ­¥...');
                        } else {
                            this.showError('æœªé€£æ¥åˆ°æœå‹™å™¨');
                        }
                    };
                    
                    // è¼¸å…¥é©—è­‰
                    const inputs = document.querySelectorAll('input[type="number"]');
                    inputs.forEach(input => {
                        input.oninput = () => {
                            this.hideError();
                            
                            // æ™‚é–“æ ¼å¼åŒ–
                            if (input.id === 'time-seconds' || input.id === 'time-minutes') {
                                let value = parseInt(input.value);
                                if (value > 59) input.value = 59;
                                else if (value < 0) input.value = 0;
                            }
                            
                            // åº§æ¨™é™åˆ¶
                            if (input.id === 'coord-x' || input.id === 'coord-y') {
                                let value = parseInt(input.value);
                                if (value > 9999) input.value = 9999;
                                else if (value < 0) input.value = 0;
                            }
                        };
                        
                        // Enter éµæäº¤
                        input.onkeypress = (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                document.getElementById('countdown-form').dispatchEvent(new Event('submit'));
                            }
                        };
                    });
                    
                    // åº§æ¨™é‡è¤‡æª¢æŸ¥
                    const coordX = document.getElementById('coord-x');
                    const coordY = document.getElementById('coord-y');
                    
                    const checkCoords = () => {
                        const x = parseInt(coordX.value);
                        const y = parseInt(coordY.value);
                        
                        if (!isNaN(x) && !isNaN(y)) {
                            const existing = this.countdowns.find(c => c.x === x && c.y === y);
                            if (existing) {
                                coordX.style.borderColor = '#f59e0b';
                                coordY.style.borderColor = '#f59e0b';
                                coordX.style.backgroundColor = '#fffbeb';
                                coordY.style.backgroundColor = '#fffbeb';
                            } else {
                                coordX.style.borderColor = '';
                                coordY.style.borderColor = '';
                                coordX.style.backgroundColor = '';
                                coordY.style.backgroundColor = '';
                            }
                        }
                    };
                    
                    coordX.oninput = checkCoords;
                    coordY.oninput = checkCoords;
                    
                    // é–‹å§‹æ›´æ–°å€’è¨ˆæ™‚
                    setInterval(() => {
                        this.updateTimers();
                    }, 1000);
                }
                
                addCountdown() {
                    if (!this.isConnected) {
                        this.showError('æœªé€£æ¥åˆ°æœå‹™å™¨');
                        return;
                    }
                    
                    const x = parseInt(document.getElementById('coord-x').value);
                    const y = parseInt(document.getElementById('coord-y').value);
                    const minutes = parseInt(document.getElementById('time-minutes').value) || 0;
                    const seconds = parseInt(document.getElementById('time-seconds').value) || 0;
                    
                    // ç°¡å–®é©—è­‰
                    if (isNaN(x) || isNaN(y) || x < 0 || y < 0) {
                        this.showError('è«‹è¼¸å…¥æœ‰æ•ˆåº§æ¨™ (0-9999)');
                        return;
                    }
                    
                    if (minutes < 0 || seconds < 0 || minutes > 59 || seconds > 59) {
                        this.showError('è«‹è¼¸å…¥æœ‰æ•ˆæ™‚é–“ (0-59)');
                        return;
                    }
                    
                    if (minutes === 0 && seconds === 0) {
                        this.showError('æ™‚é–“ä¸èƒ½ç‚º0');
                        return;
                    }
                    
                    // æª¢æŸ¥é‡è¤‡åº§æ¨™
                    const existing = this.countdowns.find(c => c.x === x && c.y === y);
                    if (existing) {
                        const remaining = Math.max(0, existing.endTime - Date.now());
                        const timeStr = remaining > 0 ? this.formatTime(remaining) : 'å·²çµæŸ';
                        this.showError(`åº§æ¨™ (${x}, ${y}) å·²å­˜åœ¨å€’è¨ˆæ™‚ï¼\nå‰µå»ºè€…ï¼š${existing.createdBy}\nå‰©é¤˜æ™‚é–“ï¼š${timeStr}`);
                        this.highlight(existing.id);
                        return;
                    }
                    
                    // ç™¼é€åˆ°æœå‹™å™¨
                    this.socket.emit('add-countdown', {
                        x, y, minutes, seconds,
                        user: this.currentUser
                    });
                    
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('countdown-form').reset();
                    this.hideError();
                    console.log(`ğŸ“¤ æ·»åŠ å€’è¨ˆæ™‚: (${x},${y}) ${minutes}:${seconds}`);
                }
                
                render() {
                    const container = document.getElementById('countdown-list');
                    
                    if (this.countdowns.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">â³</div>
                                <p>å°šç„¡å€’è¨ˆæ™‚<br>é–‹å§‹æ·»åŠ å§ï¼</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // æ’åºï¼šæ´»èºçš„åœ¨å‰
                    const now = Date.now();
                    this.countdowns.sort((a, b) => {
                        const aRemaining = Math.max(0, a.endTime - now);
                        const bRemaining = Math.max(0, b.endTime - now);
                        
                        // æœªéæœŸçš„æ’åœ¨å‰é¢ï¼ŒæŒ‰å‰©é¤˜æ™‚é–“å‡åº
                        if (aRemaining > 0 && bRemaining > 0) {
                            return aRemaining - bRemaining;
                        }
                        
                        // éæœŸçš„æ’åœ¨å¾Œé¢ï¼ŒæŒ‰éæœŸæ™‚é–“é™åº
                        if (aRemaining === 0 && bRemaining === 0) {
                            return b.endTime - a.endTime;
                        }
                        
                        // æœªéæœŸçš„åœ¨å‰
                        return bRemaining - aRemaining;
                    });
                    
                    container.innerHTML = this.countdowns.map(item => {
                        const remaining = Math.max(0, item.endTime - now);
                        const isExpired = remaining === 0;
                        const isWarning = remaining > 0 && remaining <= 60000;
                        const timeStr = isExpired ? 'å·²çµæŸ' : this.formatTime(remaining);
                        const endTimeStr = new Date(item.endTime).toLocaleString('zh-TW', {
                            timeZone: 'Asia/Taipei',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        });
                        
                        const itemClass = isExpired ? 'expired' : (isWarning ? 'warning' : '');
                        const timerClass = isExpired ? 'expired' : (isWarning ? 'warning' : '');
                        
                        return `
                            <div class="countdown-item ${itemClass} fade-in" data-id="${item.id}">
                                <div class="countdown-header">
                                    <div class="countdown-coordinates">ğŸ“ (${item.x}, ${item.y})</div>
                                    <button class="remove-btn" onclick="app.removeCountdown(${item.id})" title="ç§»é™¤å€’è¨ˆæ™‚">Ã—</button>
                                </div>
                                <div class="countdown-timer ${timerClass}">${timeStr}</div>
                                <div class="countdown-info">
                                    <div class="countdown-author">
                                        <span class="author-badge" style="background-color: ${item.createdByColor}"></span>
                                        ${item.createdBy}
                                    </div>
                                    <div class="countdown-endtime">ğŸ• ${endTimeStr}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                removeCountdown(id) {
                    if (!this.isConnected) {
                        this.showError('æœªé€£æ¥åˆ°æœå‹™å™¨');
                        return;
                    }
                    
                    if (confirm('ç¢ºå®šç§»é™¤æ­¤å€’è¨ˆæ™‚ï¼Ÿ')) {
                        this.socket.emit('remove-countdown', { id });
                    }
                }
                
                updateTimers() {
                    if (this.countdowns.length === 0) return;
                    
                    const now = Date.now();
                    
                    this.countdowns.forEach(item => {
                        const element = document.querySelector(`[data-id="${item.id}"] .countdown-timer`);
                        if (element) {
                            const remaining = Math.max(0, item.endTime - now);
                            const isExpired = remaining === 0;
                            const isWarning = remaining > 0 && remaining <= 60000;
                            const timeStr = isExpired ? 'å·²çµæŸ' : this.formatTime(remaining);
                            
                            element.textContent = timeStr;
                            element.className = `countdown-timer ${isExpired ? 'expired' : (isWarning ? 'warning' : '')}`;
                            
                            const itemElement = element.closest('.countdown-item');
                            if (itemElement) {
                                itemElement.className = `countdown-item ${isExpired ? 'expired' : (isWarning ? 'warning' : '')} fade-in`;
                            }
                        }
                    });
                }
                
                formatTime(ms) {
                    const totalSeconds = Math.floor(ms / 1000);
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                highlight(id) {
                    const element = document.querySelector(`[data-id="${id}"]`);
                    if (element) {
                        element.classList.remove('highlight-duplicate');
                        element.offsetHeight; // å¼·åˆ¶é‡æ’
                        element.classList.add('highlight-duplicate');
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => {
                            element.classList.remove('highlight-duplicate');
                        }, 3000);
                    }
                }
                
                updateStatus(text) {
                    document.getElementById('connection-text').textContent = text;
                    const indicator = document.getElementById('connection-indicator');
                    if (text.includes('å·²é€£ç·š')) {
                        indicator.classList.remove('disconnected');
                    } else {
                        indicator.classList.add('disconnected');
                    }
                }
                
                showMessage(msg) {
                    const errorDiv = document.getElementById('error-message');
                    errorDiv.innerHTML = msg;
                    errorDiv.classList.add('show');
                    setTimeout(() => this.hideError(), 2000);
                }
                
                showError(msg) {
                    const errorDiv = document.getElementById('error-message');
                    const formattedMessage = msg.replace(/\n/g, '<br>');
                    errorDiv.innerHTML = `âŒ ${formattedMessage}`;
                    errorDiv.classList.add('show');
                    setTimeout(() => this.hideError(), 7000);
                }
                
                hideError() {
                    const errorDiv = document.getElementById('error-message');
                    errorDiv.classList.remove('show');
                }
            }
            
            // å•Ÿå‹•æ‡‰ç”¨
            window.app = new SimpleCountdownApp();
            console.log('âœ… æ‡‰ç”¨å•Ÿå‹•å®Œæˆ');
        }

        function showError(message) {
            document.getElementById('countdown-list').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âŒ</div>
                    <p>${message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>