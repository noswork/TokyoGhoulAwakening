<script>
// å¤šäººå”ä½œå€’è¨ˆæ™‚å·¥å…·
class CountdownManager {
    constructor() {
        this.socket = io();
        this.countdowns = [];
        this.updateInterval = null;
        this.currentUser = null;
        
        this.showUserNameModal();
    }

    // é¡¯ç¤ºç”¨æˆ¶åè¼¸å…¥æ¨¡æ…‹æ¡†
    showUserNameModal() {
        const modal = document.getElementById('user-modal');
        const nameInput = document.getElementById('user-name-input');
        const confirmBtn = document.getElementById('confirm-name');
        const randomBtn = document.getElementById('random-name');

        // éš¨æ©Ÿåå­—ç”Ÿæˆ
        randomBtn.addEventListener('click', () => {
            nameInput.value = this.generateRandomName();
        });

        // ç¢ºèªæŒ‰éˆ•
        confirmBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            if (name.length >= 2) {
                this.setUserName(name);
                modal.style.display = 'none';
                this.initializeApp();
            } else {
                alert('åå­—è‡³å°‘éœ€è¦2å€‹å­—ç¬¦');
            }
        });

        // Enter éµç¢ºèª
        nameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                confirmBtn.click();
            }
        });

        // è‡ªå‹•èšç„¦
        nameInput.focus();
    }

    // ç”Ÿæˆéš¨æ©Ÿç”¨æˆ¶å
    generateRandomName() {
        const adjectives = ['å‹¤å¥®çš„', 'è°æ˜çš„', 'å¿«é€Ÿçš„', 'æº–ç¢ºçš„', 'å°ˆæ³¨çš„', 'å‰µæ–°çš„', 'ç©æ¥µçš„', 'é«˜æ•ˆçš„', 'å‹å–„çš„', 'æ¨‚è§€çš„'];
        const nouns = ['æˆ°å£«', 'å·¥ç¨‹å¸«', 'è¨­è¨ˆå¸«', 'åˆ†æå¸«', 'å°ˆå®¶', 'ç®¡ç†è€…', 'é–‹ç™¼è€…', 'ç­–ç•¥å®¶', 'å‰µä½œè€…', 'æ¢ç´¢è€…'];
        const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
        const noun = nouns[Math.floor(Math.random() * nouns.length)];
        const number = Math.floor(Math.random() * 99) + 1;
        return `${adjective}${noun}${number}`;
    }

    // è¨­ç½®ç”¨æˆ¶åå’Œé¡è‰²
    setUserName(name) {
        this.currentUser = {
            name: name,
            color: this.generateUserColor()
        };
        
        // æ›´æ–°UIé¡¯ç¤º
        document.getElementById('current-user-name').textContent = name;
        document.getElementById('current-user-color').style.backgroundColor = this.currentUser.color;
    }

    // ç”Ÿæˆç”¨æˆ¶é¡è‰²
    generateUserColor() {
        const colors = [
            '#3b82f6', '#ef4444', '#10b981', '#f59e0b', 
            '#8b5cf6', '#06b6d4', '#84cc16', '#f97316',
            '#ec4899', '#6366f1', '#14b8a6', '#fbbf24'
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    // åˆå§‹åŒ–æ‡‰ç”¨
    initializeApp() {
        this.setupSocketEvents();
        this.setupUIEvents();
        this.startUpdating();
        
        console.log('ğŸš€ å€’è¨ˆæ™‚ç®¡ç†å·¥å…·å·²åˆå§‹åŒ–');
    }

    setupSocketEvents() {
        // é€£æ¥ç‹€æ…‹
        this.socket.on('connect', () => {
            this.updateConnectionStatus(true);
            // ç™¼é€ç”¨æˆ¶ä¿¡æ¯åˆ°æœå‹™å™¨
            this.socket.emit('set-user-info', this.currentUser);
            console.log('âœ… å·²é€£æ¥åˆ°æœå‹™å™¨');
        });

        this.socket.on('disconnect', () => {
            this.updateConnectionStatus(false);
            console.log('âŒ èˆ‡æœå‹™å™¨æ–·é–‹é€£æ¥');
        });

        this.socket.on('connect_error', (error) => {
            this.updateConnectionStatus(false);
            console.error('ğŸ”Œ é€£æ¥éŒ¯èª¤:', error);
        });

        // å€’è¨ˆæ™‚äº‹ä»¶
        this.socket.on('countdown-list', (countdowns) => {
            this.countdowns = countdowns;
            this.renderCountdowns();
            console.log(`ğŸ“‹ æ”¶åˆ° ${countdowns.length} å€‹å€’è¨ˆæ™‚é …ç›®`);
        });

        this.socket.on('countdown-added', (countdown) => {
            this.countdowns.push(countdown);
            this.sortCountdowns();
            this.renderCountdowns();
            console.log(`â• æ–°å¢å€’è¨ˆæ™‚: (${countdown.x},${countdown.y})`);
        });

        this.socket.on('countdown-removed', (data) => {
            this.countdowns = this.countdowns.filter(c => c.id !== data.id);
            this.renderCountdowns();
            console.log(`ğŸ—‘ï¸ ç§»é™¤å€’è¨ˆæ™‚ ID: ${data.id}`);
        });

        this.socket.on('countdowns-cleared', () => {
            this.countdowns = [];
            this.renderCountdowns();
            console.log('ğŸ§¹ æ‰€æœ‰å€’è¨ˆæ™‚å·²æ¸…ç©º');
        });

        // éŒ¯èª¤è™•ç†
        this.socket.on('error', (data) => {
            this.showError(data.message);
            console.error('âŒ æœå‹™å™¨éŒ¯èª¤:', data.message);
        });

        // ç”¨æˆ¶äº‹ä»¶
        this.socket.on('user-joined', (user) => {
            console.log(`ğŸ‘‹ ${user.name} åŠ å…¥äº†`);
        });

        this.socket.on('user-left', (userId) => {
            console.log(`ğŸ‘‹ ç”¨æˆ¶ ${userId} é›¢é–‹äº†`);
        });
    }

    setupUIEvents() {
        // è¡¨å–®æäº¤
        const form = document.getElementById('countdown-form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.addCountdown();
        });

        // æ¸…ç©ºæ‰€æœ‰æŒ‰éˆ•
        const clearBtn = document.getElementById('clear-all-btn');
        clearBtn.addEventListener('click', () => {
            if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å€’è¨ˆæ™‚å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                this.socket.emit('clear-all');
            }
        });

        // è¼¸å…¥é©—è­‰å’Œæ ¼å¼åŒ–
        const inputs = form.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                this.hideError();
                
                // è‡ªå‹•æ ¼å¼åŒ–æ™‚é–“è¼¸å…¥
                if (input.id === 'time-seconds' || input.id === 'time-minutes') {
                    let value = parseInt(input.value);
                    if (value > 59) {
                        input.value = 59;
                    } else if (value < 0) {
                        input.value = 0;
                    }
                }
                
                // åº§æ¨™ç¯„åœé™åˆ¶
                if (input.id === 'coord-x' || input.id === 'coord-y') {
                    let value = parseInt(input.value);
                    if (value > 9999) {
                        input.value = 9999;
                    } else if (value < 0) {
                        input.value = 0;
                    }
                }
            });
            
            // Enter éµå¿«é€Ÿæäº¤
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    form.dispatchEvent(new Event('submit'));
                }
            });
        });
    }

    addCountdown() {
        const x = parseInt(document.getElementById('coord-x').value);
        const y = parseInt(document.getElementById('coord-y').value);
        const minutes = parseInt(document.getElementById('time-minutes').value) || 0;
        const seconds = parseInt(document.getElementById('time-seconds').value) || 0;

        // å‰ç«¯é©—è­‰
        if (isNaN(x) || isNaN(y) || x < 0 || y < 0) {
            this.showError('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„åº§æ¨™ (0-9999)');
            return;
        }

        if (minutes < 0 || seconds < 0 || minutes > 59 || seconds > 59) {
            this.showError('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„æ™‚é–“ (0-59)');
            return;
        }

        if (minutes === 0 && seconds === 0) {
            this.showError('âŒ æ™‚é–“å¿…é ˆå¤§æ–¼ 0');
            return;
        }

        // æª¢æŸ¥æ˜¯å¦å·²é€£æ¥
        if (!this.socket.connected) {
            this.showError('âŒ èˆ‡æœå‹™å™¨æ–·é–‹é€£æ¥ï¼Œè«‹ç¨å¾Œé‡è©¦');
            return;
        }

        // ç™¼é€åˆ°æœå‹™å™¨
        this.socket.emit('add-countdown', { 
            x, y, minutes, seconds,
            user: this.currentUser
        });

        // æ¸…ç©ºè¡¨å–®
        document.getElementById('countdown-form').reset();
        this.hideError();
        
        console.log(`ğŸ“¤ ç™¼é€å€’è¨ˆæ™‚: (${x},${y}) ${minutes}:${seconds.toString().padStart(2, '0')}`);
    }

    removeCountdown(id) {
        if (!this.socket.connected) {
            this.showError('âŒ èˆ‡æœå‹™å™¨æ–·é–‹é€£æ¥');
            return;
        }
        this.socket.emit('remove-countdown', { id });
    }

    sortCountdowns() {
        const now = Date.now();
        this.countdowns.sort((a, b) => {
            const aRemaining = Math.max(0, a.endTime - now);
            const bRemaining = Math.max(0, b.endTime - now);
            
            // æœªéæœŸçš„æ’åœ¨å‰é¢ï¼ŒæŒ‰å‰©é¤˜æ™‚é–“å‡åº
            if (aRemaining > 0 && bRemaining > 0) {
                return aRemaining - bRemaining;
            }
            
            // éæœŸçš„æ’åœ¨å¾Œé¢ï¼ŒæŒ‰éæœŸæ™‚é–“é™åº
            if (aRemaining === 0 && bRemaining === 0) {
                return b.endTime - a.endTime;
            }
            
            // æœªéæœŸçš„åœ¨å‰
            return bRemaining - aRemaining;
        });
    }

    // æ–°å¢ï¼šåªæ›´æ–°è¨ˆæ™‚å™¨æ–‡å­—çš„æ–¹æ³•
    updateCountdownTimers() {
        this.countdowns.forEach(countdown => {
            const timerElement = document.querySelector(`[data-countdown-id="${countdown.id}"] .countdown-timer`);
            if (timerElement) {
                const now = Date.now();
                const remaining = Math.max(0, countdown.endTime - now);
                const isExpired = remaining === 0;
                const isWarning = remaining > 0 && remaining <= 60000;
                
                // æ›´æ–°è¨ˆæ™‚å™¨æ–‡å­—
                const timerText = isExpired ? 'å·²çµæŸ' : this.formatTime(remaining);
                timerElement.textContent = timerText;
                
                // æ›´æ–°æ¨£å¼é¡
                timerElement.className = 'countdown-timer' + 
                    (isExpired ? ' expired' : (isWarning ? ' warning' : ''));
                
                // æ›´æ–°æ•´å€‹é …ç›®çš„æ¨£å¼é¡
                const itemElement = timerElement.closest('.countdown-item');
                if (itemElement) {
                    itemElement.className = 'countdown-item' + 
                        (isExpired ? ' expired' : (isWarning ? ' warning' : ''));
                }
            }
        });
    }

    renderCountdowns() {
        const container = document.getElementById('countdown-list');
        
        if (this.countdowns.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">â³</div>
                    <p>å°šç„¡å€’è¨ˆæ™‚é …ç›®<br>é–‹å§‹æ·»åŠ ç¬¬ä¸€å€‹å§ï¼</p>
                </div>
            `;
            return;
        }

        this.sortCountdowns();
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“æ•´å€‹åˆ—è¡¨
        const existingIds = Array.from(container.querySelectorAll('[data-countdown-id]'))
            .map(el => parseInt(el.dataset.countdownId));
        const currentIds = this.countdowns.map(c => c.id);
        
        // å¦‚æœé …ç›®æ•¸é‡æˆ–IDä¸åŒï¼Œæ‰é‡æ–°æ¸²æŸ“æ•´å€‹åˆ—è¡¨
        const needsFullRender = existingIds.length !== currentIds.length || 
            !existingIds.every(id => currentIds.includes(id)) ||
            !currentIds.every(id => existingIds.includes(id));
        
        if (needsFullRender) {
            container.innerHTML = this.countdowns.map(countdown => {
                const now = Date.now();
                const remaining = Math.max(0, countdown.endTime - now);
                const isExpired = remaining === 0;
                const isWarning = remaining > 0 && remaining <= 60000;
                
                return this.createCountdownHTML(countdown, remaining, isExpired, isWarning);
            }).join('');

            // é‡æ–°æ·»åŠ ç§»é™¤æŒ‰éˆ•äº‹ä»¶
            container.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = parseInt(btn.dataset.id);
                    if (confirm('ç¢ºå®šè¦ç§»é™¤é€™å€‹å€’è¨ˆæ™‚å—ï¼Ÿ')) {
                        this.removeCountdown(id);
                    }
                });
            });
        }
    }

    createCountdownHTML(countdown, remaining, isExpired, isWarning) {
        const endTimeStr = this.formatDateTime(new Date(countdown.endTime));
        const timerText = isExpired ? 'å·²çµæŸ' : this.formatTime(remaining);
        const itemClass = isExpired ? 'expired' : (isWarning ? 'warning' : '');
        const timerClass = isExpired ? 'expired' : (isWarning ? 'warning' : '');

        return `
            <div class="countdown-item ${itemClass} fade-in" data-countdown-id="${countdown.id}">
                <div class="countdown-header">
                    <div class="countdown-coordinates">ğŸ“ (${countdown.x}, ${countdown.y})</div>
                    <button class="remove-btn" data-id="${countdown.id}" title="ç§»é™¤å€’è¨ˆæ™‚">Ã—</button>
                </div>
                <div class="countdown-timer ${timerClass}">${timerText}</div>
                <div class="countdown-info">
                    <div class="countdown-author">
                        <span class="author-badge" style="background-color: ${countdown.createdByColor}"></span>
                        ${countdown.createdBy}
                    </div>
                    <div class="countdown-endtime">ğŸ• ${endTimeStr}</div>
                </div>
            </div>
        `;
    }

    formatTime(milliseconds) {
        const totalSeconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    formatDateTime(date) {
        // å°ç£æ™‚é–“æ ¼å¼åŒ–
        return date.toLocaleString('zh-TW', {
            timeZone: 'Asia/Taipei',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
    }

    // ä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„æ›´æ–°æ–¹æ³•
    startUpdating() {
        // æ¯ç§’æ›´æ–°ä¸€æ¬¡é¡¯ç¤º
        this.updateInterval = setInterval(() => {
            if (this.countdowns.length > 0) {
                // åªæ›´æ–°è¨ˆæ™‚å™¨æ–‡å­—ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´å€‹åˆ—è¡¨
                this.updateCountdownTimers();
            }
        }, 1000);
    }

    updateConnectionStatus(connected) {
        const indicator = document.getElementById('connection-indicator');
        const text = document.getElementById('connection-text');
        
        if (connected) {
            indicator.classList.remove('disconnected');
            text.textContent = 'ğŸŸ¢ å·²é€£ç·š';
        } else {
            indicator.classList.add('disconnected');
            text.textContent = 'ğŸ”´ é€£ç·šä¸­æ–·';
        }
    }

    showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.classList.add('show');
        
        // 5ç§’å¾Œè‡ªå‹•éš±è—
        setTimeout(() => {
            this.hideError();
        }, 5000);
    }

    hideError() {
        const errorDiv = document.getElementById('error-message');
        errorDiv.classList.remove('show');
    }
}

// åˆå§‹åŒ–æ‡‰ç”¨
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸ¯ æ­£åœ¨åˆå§‹åŒ–å¤šäººå”ä½œå€’è¨ˆæ™‚å·¥å…·...');
    window.countdownManager = new CountdownManager();
});
</script>